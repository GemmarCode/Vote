{% extends 'admin_base.html' %}

{% block admin_content %}
<div class="d-flex">
    <!-- Main Content -->
    <div class="flex-grow-1 p-4" style="background-color: white;">
        <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="header-title mb-0">Add Candidates</h1>
                <button type="button" class="btn btn-primary" id="manageCandidatesBtn" data-bs-toggle="modal" data-bs-target="#manageCandidatesModal" style="background-color: #1976D2;">
                    <i class="fas fa-users me-2"></i>Manage Candidates
                </button>
            </div>

            <!-- Add Candidate Form -->
            <div class="admin-card">
                <div class="card-header py-3" style="background-color: #1976D2;">
                    <h5 class="card-title mb-0 text-white">Add New Candidate</h5>
                </div>
                <div class="card-body p-4">
                    <form method="POST" enctype="multipart/form-data" id="candidateForm">
                        {% csrf_token %}
                        <div class="row g-3">
                            <!-- User Selection -->
                            <div class="col-md-6">
                                <label class="form-label" style="color: #1976D2;">Search Student Number</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="userSearch" placeholder="Enter student number..." autocomplete="off">
                                    <input type="hidden" name="user_profile_id" id="selectedUserId" required>
                                </div>
                                <div id="searchResults" class="position-absolute bg-white shadow-sm rounded-bottom border" style="display: none; z-index: 1000; width: calc(100% - 24px); max-height: 200px; overflow-y: auto;"></div>
                            </div>

                            <!-- Position -->
                            <div class="col-md-6">
                                <label class="form-label" style="color: #1976D2;">Position</label>
                                <select class="form-select" name="position" id="positionSelect" required>
                                    <option value="">Select position...</option>
                                    <optgroup label="National Positions">
                                        {% for position in national_positions %}
                                        <option value="{{ position.0 }}">{{ position.1 }}</option>
                                        {% endfor %}
                                    </optgroup>
                                    <optgroup label="College Positions">
                                        {% for position in college_positions %}
                                        <option value="{{ position.0 }}">{{ position.1 }}</option>
                                        {% endfor %}
                                    </optgroup>
                                    <optgroup label="Department Positions">
                                        {% for position in local_positions %}
                                        <option value="{{ position.0 }}">{{ position.1 }}</option>
                                        {% endfor %}
                                    </optgroup>
                                </select>
                                <div class="form-text mt-1" id="positionHelp">Select a position to see required fields</div>
                            </div>

                            <!-- Photo Upload -->
                            <div class="col-12">
                                <label class="form-label" style="color: #1976D2;">Candidate Photo</label>
                                <input type="file" class="form-control" name="photo" accept="image/*">
                            </div>

                            <!-- Platform -->
                            <div class="col-12">
                                <label class="form-label" style="color: #1976D2;">Platform</label>
                                <textarea class="form-control" name="platform" rows="4"></textarea>
                            </div>

                            <!-- Achievements -->
                            <div class="col-12">
                                <label class="form-label" style="color: #1976D2;">Achievements</label>
                                <textarea class="form-control" name="achievements" rows="4"></textarea>
                            </div>

                            <!-- Submit Button -->
                            <div class="col-12 mt-4">
                                <button type="button" id="submitBtn" class="btn btn-lg w-100" style="background-color: #1976D2; color: white;">
                                    <i class="fas fa-plus-circle me-2"></i>Add Candidate
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Confirmation Modal -->
            <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header" style="background-color: #1976D2; color: white;">
                            <h5 class="modal-title" id="confirmModalLabel">Confirm Candidate Addition</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p>Are you sure you want to add this candidate?</p>
                            <div id="candidatePreview">
                                <p><strong>Student Number:</strong> <span id="previewStudentNumber"></span></p>
                                <p><strong>Position:</strong> <span id="previewPosition"></span></p>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" id="confirmAddBtn" class="btn btn-primary" style="background-color: #1976D2;">Confirm</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Success Modal -->
            <div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header" style="background-color: #1976D2; color: white;">
                            <h5 class="modal-title" id="successModalLabel">Success!</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p>Candidate has been successfully added!</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" data-bs-dismiss="modal" style="background-color: #1976D2;">OK</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Manage Candidates Modal -->
            <div class="modal fade" id="manageCandidatesModal" tabindex="-1" aria-labelledby="manageCandidatesModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header" style="background-color: #1976D2; color: white;">
                            <h5 class="modal-title" id="manageCandidatesModalLabel">Manage Candidates</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <input type="text" class="form-control" id="candidateSearchInput" placeholder="Search candidates by student number, name, or position...">
                            </div>
                            <div class="table-responsive">
                                <table class="table" id="candidatesTable">
                                    <thead class="table-header">
                                        <tr>
                                            <th>Photo</th>
                                            <th>Student Number</th>
                                            <th>Position</th>
                                            <th>Platform</th>
                                            <th>Achievements</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for candidate in candidates %}
                                        <tr>
                                            <td>
                                                {% if candidate.photo %}
                                                    <img src="{{ candidate.photo.url }}" alt="Candidate Photo" 
                                                         style="width: 40px; height: 40px; object-fit: cover; border-radius: 50%;">
                                                {% else %}
                                                    <div class="rounded-circle d-flex align-items-center justify-content-center"
                                                         style="width: 40px; height: 40px; background-color: #E3F2FD;">
                                                        <i class="fas fa-user" style="color: #1976D2;"></i>
                                                    </div>
                                                {% endif %}
                                            </td>
                                            <td>{{ candidate.user_profile.student_number }}</td>
                                            <td>{{ candidate.get_position_display }}</td>
                                            <td>
                                                <button class="btn btn-sm btn-info view-platform" data-platform="{{ candidate.platform }}" title="View Platform">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </td>
                                            <td>
                                                <button class="btn btn-sm btn-info view-achievements" data-achievements="{{ candidate.achievements }}" title="View Achievements">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </td>
                                            <td>
                                                <button type="button" class="btn btn-sm btn-primary edit-candidate-btn" 
                                                    data-candidate-id="{{ candidate.id }}"
                                                    data-student-number="{{ candidate.user_profile.student_number }}"
                                                    data-position="{{ candidate.position }}"
                                                    data-platform="{{ candidate.platform }}"
                                                    data-achievements="{{ candidate.achievements }}"
                                                    data-photo-url="{% if candidate.photo %}{{ candidate.photo.url }}{% endif %}"
                                                    title="Edit Candidate">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Platform View Modal -->
<div class="modal fade" id="platformModal" tabindex="-1" aria-labelledby="platformModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header" style="background-color: #1976D2; color: white;">
        <h5 class="modal-title" id="platformModalLabel">Candidate Platform</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p id="platformContent"></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Achievements View Modal -->
<div class="modal fade" id="achievementsModal" tabindex="-1" aria-labelledby="achievementsModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header" style="background-color: #1976D2; color: white;">
        <h5 class="modal-title" id="achievementsModalLabel">Candidate Achievements</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p id="achievementsContent"></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Candidate Modal -->
<div class="modal fade" id="editCandidateModal" tabindex="-1" aria-labelledby="editCandidateModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header" style="background-color: #1976D2; color: white;">
        <h5 class="modal-title" id="editCandidateModalLabel">Edit Candidate</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="POST" enctype="multipart/form-data" id="editCandidateForm">
        {% csrf_token %}
        <input type="hidden" name="action" value="edit">
        <input type="hidden" name="candidate_id" id="editCandidateId">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Student Number</label>
            <input type="text" class="form-control" id="editStudentNumber" name="student_number" readonly>
          </div>
          <div class="mb-3">
            <label class="form-label">Position</label>
            <select class="form-select" name="position" id="editPositionSelect" required>
              <option value="">Select position...</option>
              <optgroup label="National Positions">
                {% for position in national_positions %}
                <option value="{{ position.0 }}">{{ position.1 }}</option>
                {% endfor %}
              </optgroup>
              <optgroup label="College Positions">
                {% for position in college_positions %}
                <option value="{{ position.0 }}">{{ position.1 }}</option>
                {% endfor %}
              </optgroup>
              <optgroup label="Department Positions">
                {% for position in local_positions %}
                <option value="{{ position.0 }}">{{ position.1 }}</option>
                {% endfor %}
              </optgroup>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Platform</label>
            <textarea class="form-control" name="platform" id="editPlatform" rows="3"></textarea>
          </div>
          <div class="mb-3">
            <label class="form-label">Achievements</label>
            <textarea class="form-control" name="achievements" id="editAchievements" rows="3"></textarea>
          </div>
          <div class="mb-3">
            <label class="form-label">Photo</label>
            <input type="file" class="form-control" name="photo">
            <div id="editPhotoPreview" class="mt-2"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary" style="background-color: #1976D2;">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<style>
.header-title {
    color: #1976D2 !important;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
    font-weight: 700;
}

.admin-card {
    background: white;
    border-radius: 10px;
    box-shadow: 0 8px 16px rgba(25, 118, 210, 0.15);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    border: 1px solid rgba(25, 118, 210, 0.08);
    overflow: hidden;
}

.admin-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 12px 24px rgba(25, 118, 210, 0.25);
}

.table-header {
    background-color: rgba(25, 118, 210, 0.1);
}

.table-header th {
    color: #1976D2;
    font-weight: 600;
}

.btn-info {
    background-color: #42A5F5;
    border-color: #42A5F5;
}

.btn-info:hover {
    background-color: #1976D2;
    border-color: #1976D2;
}

.form-control:focus, .form-select:focus {
    border-color: #1976D2;
    box-shadow: 0 0 0 0.25rem rgba(25, 118, 210, 0.25);
}
</style>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const positionSelect = document.getElementById('positionSelect');
    const positionHelp = document.getElementById('positionHelp');
    const submitBtn = document.getElementById('submitBtn');
    const confirmAddBtn = document.getElementById('confirmAddBtn');
    const candidateForm = document.getElementById('candidateForm');
    const previewStudentNumber = document.getElementById('previewStudentNumber');
    const previewPosition = document.getElementById('previewPosition');

    // Set up position change handler
    positionSelect.addEventListener('change', function() {
        const selectedPosition = this.value;
        
        // National positions don't need additional fields
        const nationalPositions = [
            'PRESIDENT', 'VICE_PRESIDENT', 'SECRETARY', 
            'TREASURER', 'AUDITOR', 'PIO', 'REPRESENTATIVE'
        ];
        
        // College positions need college field
        const collegePositions = [
            'GOVERNOR', 'VICE_GOVERNOR', 'SECRETARY_COLLEGE', 
            'TREASURER_COLLEGE', 'AUDITOR_COLLEGE', 'PRO_COLLEGE'
        ];
        
        // Department positions need college, department and year level
        const departmentPositions = [
            'MAYOR', 'VICE_MAYOR', 'SECRETARY_DEPT', 
            'TREASURER_DEPT', 'AUDITOR_DEPT', 'PRO_DEPT', 
            'REPRESENTATIVE_DEPT'
        ];
        
        // Set help text based on position type
        if (selectedPosition) {
            if (collegePositions.includes(selectedPosition)) {
                positionHelp.textContent = 'College position selected';
            } 
            else if (departmentPositions.includes(selectedPosition)) {
                positionHelp.textContent = 'Department position selected';
            }
            else if (nationalPositions.includes(selectedPosition)) {
                positionHelp.textContent = 'National position selected';
            }
            else {
                positionHelp.textContent = 'Unknown position type - please select valid position';
            }
        } else {
            positionHelp.textContent = 'Select a position';
        }
    });

    // Show confirmation modal before form submission
    submitBtn.addEventListener('click', function(e) {
        e.preventDefault();
        // Validate form
        const studentId = document.getElementById('selectedUserId').value;
        const position = positionSelect.value;
        if (!studentId || !position) {
            alert('Please fill in all required fields: Student Number and Position.');
            return;
        }
        // Get student number for preview
        const selectedUser = users.find(u => u.id == studentId);
        if (selectedUser) {
            previewStudentNumber.textContent = selectedUser.student_number;
            previewPosition.textContent = positionSelect.options[positionSelect.selectedIndex].text;
            // Show confirmation modal
            const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
            confirmModal.show();
        } else {
            alert('Please select a valid student number.');
        }
    });
    
    // Handle confirmation button click
    confirmAddBtn.addEventListener('click', function() {
        // Submit the form
        candidateForm.submit();
    });

    // User search functionality
    const userSearch = document.getElementById('userSearch');
    const searchResults = document.getElementById('searchResults');
    const selectedUserId = document.getElementById('selectedUserId');
    
    // Parse the JSON data provided by the server
    const users = JSON.parse('{{ users_json|escapejs }}');

    userSearch.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        if (searchTerm.length < 2) {
            searchResults.style.display = 'none';
            return;
        }

        const filteredUsers = users.filter(user => 
            user.student_number.toLowerCase().includes(searchTerm) ||
            user.name.toLowerCase().includes(searchTerm)
        );

        if (filteredUsers.length > 0) {
            searchResults.innerHTML = filteredUsers.map(user => `
                <div class="p-2 cursor-pointer hover-bg-light border-bottom user-result" 
                     data-id="${user.id}" 
                     style="cursor: pointer;">
                    <div class="fw-bold">${user.student_number}</div>
                    <div class="small text-muted">${user.name}</div>
                </div>
            `).join('');
            searchResults.style.display = 'block';
        } else {
            searchResults.innerHTML = '<div class="p-2">No users found</div>';
            searchResults.style.display = 'block';
        }
    });

    // Handle click on search results
    searchResults.addEventListener('click', function(e) {
        const userResult = e.target.closest('.user-result');
        if (userResult) {
            const userId = userResult.getAttribute('data-id');
            const user = users.find(u => u.id == userId);
            
            if (user) {
                userSearch.value = user.student_number;
                selectedUserId.value = userId;
                searchResults.style.display = 'none';
            }
        }
    });

    // Check for success messages from Django
    const messages = document.querySelectorAll('.alert-success');
    if (messages.length > 0) {
        // Show success modal if there's a success message
        const successModal = new bootstrap.Modal(document.getElementById('successModal'));
        successModal.show();
    }

    // Hide results when clicking outside
    document.addEventListener('click', function(e) {
        if (!userSearch.contains(e.target) && !searchResults.contains(e.target)) {
            searchResults.style.display = 'none';
        }
    });

    // Handle view platform buttons
    const viewPlatformButtons = document.querySelectorAll('.view-platform');
    viewPlatformButtons.forEach(button => {
        button.addEventListener('click', function() {
            const platform = this.getAttribute('data-platform');
            document.getElementById('platformContent').textContent = platform || 'No platform information available';
            const platformModal = new bootstrap.Modal(document.getElementById('platformModal'));
            platformModal.show();
        });
    });

    // Handle view achievements buttons
    const viewAchievementsButtons = document.querySelectorAll('.view-achievements');
    viewAchievementsButtons.forEach(button => {
        button.addEventListener('click', function() {
            const achievements = this.getAttribute('data-achievements');
            document.getElementById('achievementsContent').textContent = achievements || 'No achievements information available';
            const achievementsModal = new bootstrap.Modal(document.getElementById('achievementsModal'));
            achievementsModal.show();
        });
    });

    // Edit Candidate Modal logic
    const editCandidateModal = new bootstrap.Modal(document.getElementById('editCandidateModal'));
    const editCandidateForm = document.getElementById('editCandidateForm');
    document.querySelectorAll('.edit-candidate-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            document.getElementById('editCandidateId').value = btn.getAttribute('data-candidate-id');
            document.getElementById('editStudentNumber').value = btn.getAttribute('data-student-number');
            document.getElementById('editPositionSelect').value = btn.getAttribute('data-position');
            document.getElementById('editPlatform').value = btn.getAttribute('data-platform');
            document.getElementById('editAchievements').value = btn.getAttribute('data-achievements');
            const photoUrl = btn.getAttribute('data-photo-url');
            const preview = document.getElementById('editPhotoPreview');
            if (photoUrl) {
                preview.innerHTML = `<img src="${photoUrl}" alt="Current Photo" style="width: 60px; height: 60px; object-fit: cover; border-radius: 50%;">`;
            } else {
                preview.innerHTML = '<span class="text-muted">No photo uploaded</span>';
            }
            editCandidateModal.show();
        });
    });

    // Remove leftover modal backdrops when any modal is hidden
    document.querySelectorAll('.modal').forEach(function(modal) {
        modal.addEventListener('hidden.bs.modal', function () {
            if (document.querySelectorAll('.modal.show').length === 0) {
                document.querySelectorAll('.modal-backdrop').forEach(function(backdrop) {
                    backdrop.parentNode.removeChild(backdrop);
                });
                document.body.classList.remove('modal-open');
                document.body.style = '';
            }
        });
    });

    // Candidate search in Manage Candidates modal
    const candidateSearchInput = document.getElementById('candidateSearchInput');
    const candidatesTable = document.getElementById('candidatesTable');
    if (candidateSearchInput && candidatesTable) {
        candidateSearchInput.addEventListener('input', function() {
            const search = candidateSearchInput.value.toLowerCase();
            const rows = candidatesTable.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(search)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
    }
});
</script>
{% endblock %}

{% endblock %} 