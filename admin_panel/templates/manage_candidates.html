{% extends 'admin_base.html' %}

{% block admin_content %}
<div class="d-flex">
    <!-- Main Content -->
    <div class="flex-grow-1 p-4" style="background-color: #D1ECFF;">
        <div class="container-fluid">
            <h1 class="mb-4" style="color: #1E5470;">Add Candidates</h1>

            <!-- Add Candidate Form -->
            <div class="card" style="background-color: #CBEAEC;">
                <div class="card-header py-3" style="background-color: #34729C;">
                    <h5 class="card-title mb-0 text-white">Add New Candidate</h5>
                </div>
                <div class="card-body p-4">
                    <form method="POST" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="row g-3">
                            <!-- User Selection -->
                            <div class="col-md-6">
                                <label class="form-label">Search User</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="userSearch" placeholder="Search by student number or name..." autocomplete="off">
                                    <input type="hidden" name="user_profile_id" id="selectedUserId" required>
                                </div>
                                <div id="searchResults" class="position-absolute bg-white shadow-sm rounded-bottom border" style="display: none; z-index: 1000; width: calc(100% - 24px); max-height: 200px; overflow-y: auto;"></div>
                            </div>

                            <!-- Position -->
                            <div class="col-md-6">
                                <label class="form-label">Position</label>
                                <select class="form-select" name="position" id="positionSelect" required>
                                    <option value="">Select position...</option>
                                    <optgroup label="National Positions">
                                        {% for position in national_positions %}
                                        <option value="{{ position.0 }}">{{ position.1 }}</option>
                                        {% endfor %}
                                    </optgroup>
                                    <optgroup label="College Positions">
                                        {% for position in college_positions %}
                                        <option value="{{ position.0 }}">{{ position.1 }}</option>
                                        {% endfor %}
                                    </optgroup>
                                    <optgroup label="Department Positions">
                                        {% for position in local_positions %}
                                        <option value="{{ position.0 }}">{{ position.1 }}</option>
                                        {% endfor %}
                                    </optgroup>
                                </select>
                                <div class="form-text mt-1" id="positionHelp">Select a position to see required fields</div>
                            </div>

                            <!-- College -->
                            <div class="col-md-4" id="collegeDiv" style="display: none;">
                                <label class="form-label">College <span class="text-danger">*</span></label>
                                <select class="form-select" name="college" id="collegeSelect">
                                    <option value="">Select college...</option>
                                    {% for college in colleges %}
                                    <option value="{{ college }}">{{ college }}</option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">Required for college and department positions</div>
                            </div>

                            <!-- Department -->
                            <div class="col-md-4" id="departmentDiv" style="display: none;">
                                <label class="form-label">Department <span class="text-danger">*</span></label>
                                <select class="form-select" name="department" id="departmentSelect">
                                    <option value="">Select department...</option>
                                    {% for department in departments %}
                                    <option value="{{ department }}">{{ department }}</option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">Required for department positions</div>
                            </div>

                            <!-- Year Level -->
                            <div class="col-md-4" id="yearLevelDiv" style="display: none;">
                                <label class="form-label">Year Level <span class="text-danger">*</span></label>
                                <select class="form-select" name="year_level" id="yearLevelSelect">
                                    <option value="">Select year level...</option>
                                    <option value="1">1st Year</option>
                                    <option value="2">2nd Year</option>
                                    <option value="3">3rd Year</option>
                                    <option value="4">4th Year</option>
                                </select>
                                <div class="form-text">Required for department positions</div>
                            </div>

                            <!-- Photo Upload -->
                            <div class="col-12">
                                <label class="form-label">Candidate Photo</label>
                                <input type="file" class="form-control" name="photo" accept="image/*">
                            </div>

                            <!-- Platform -->
                            <div class="col-12">
                                <label class="form-label">Platform</label>
                                <textarea class="form-control" name="platform" rows="4" required></textarea>
                            </div>

                            <!-- Achievements -->
                            <div class="col-12">
                                <label class="form-label">Achievements</label>
                                <textarea class="form-control" name="achievements" rows="4"></textarea>
                            </div>

                            <!-- Submit Button -->
                            <div class="col-12 mt-4">
                                <button type="submit" class="btn btn-lg w-100" style="background-color: #34729C; color: white;">
                                    <i class="fas fa-plus-circle me-2"></i>Add Candidate
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- List of Added Candidates -->
            <div class="card mt-4" style="background-color: #CBEAEC;">
                <div class="card-header py-3" style="background-color: #34729C;">
                    <h5 class="card-title mb-0 text-white">Added Candidates</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Photo</th>
                                    <th>Student Number</th>
                                    <th>Name</th>
                                    <th>Position</th>
                                    <th>College</th>
                                    <th>Department</th>
                                    <th>Year Level</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for candidate in candidates %}
                                <tr>
                                    <td>
                                        {% if candidate.photo %}
                                            <img src="{{ candidate.photo.url }}" alt="Candidate Photo" 
                                                 style="width: 40px; height: 40px; object-fit: cover; border-radius: 50%;">
                                        {% else %}
                                            <div class="rounded-circle d-flex align-items-center justify-content-center"
                                                 style="width: 40px; height: 40px; background-color: #D1ECFF;">
                                                <i class="fas fa-user" style="color: #34729C;"></i>
                                            </div>
                                        {% endif %}
                                    </td>
                                    <td>{{ candidate.user.userprofile.student_number }}</td>
                                    <td>{{ candidate.user.userprofile.student_name }}</td>
                                    <td>{{ candidate.position }}</td>
                                    <td>{{ candidate.college|default:"-" }}</td>
                                    <td>{{ candidate.department|default:"-" }}</td>
                                    <td>{{ candidate.year_level|default:"-" }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-danger delete-candidate" 
                                                data-candidate-id="{{ candidate.id }}">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const positionSelect = document.getElementById('positionSelect');
    const collegeDiv = document.getElementById('collegeDiv');
    const departmentDiv = document.getElementById('departmentDiv');
    const yearLevelDiv = document.getElementById('yearLevelDiv');
    const collegeSelect = document.getElementById('collegeSelect');
    const departmentSelect = document.getElementById('departmentSelect');
    const yearLevelSelect = document.getElementById('yearLevelSelect');
    const positionHelp = document.getElementById('positionHelp');

    // Set up position change handler
    positionSelect.addEventListener('change', function() {
        const selectedPosition = this.value;
        
        // Reset validation
        collegeSelect.required = false;
        departmentSelect.required = false;
        yearLevelSelect.required = false;
        
        // Hide all fields initially
        collegeDiv.style.display = 'none';
        departmentDiv.style.display = 'none';
        yearLevelDiv.style.display = 'none';
        
        // Show/hide fields based on position type
        if (selectedPosition) {
            // National positions don't need additional fields
            const nationalPositions = [
                'PRESIDENT', 'VICE_PRESIDENT', 'SECRETARY', 
                'TREASURER', 'AUDITOR', 'PIO', 'REPRESENTATIVE'
            ];
            
            // College positions need college field
            const collegePositions = [
                'GOVERNOR', 'VICE_GOVERNOR', 'SECRETARY_COLLEGE', 
                'TREASURER_COLLEGE', 'AUDITOR_COLLEGE', 'PRO_COLLEGE'
            ];
            
            // Department positions need college, department and year level
            const departmentPositions = [
                'MAYOR', 'VICE_MAYOR', 'SECRETARY_DEPT', 
                'TREASURER_DEPT', 'AUDITOR_DEPT', 'PRO_DEPT', 
                'REPRESENTATIVE_DEPT'
            ];
            
            if (collegePositions.includes(selectedPosition)) {
                collegeDiv.style.display = 'block';
                collegeSelect.required = true;
                positionHelp.textContent = 'College position selected - college field required';
            } 
            else if (departmentPositions.includes(selectedPosition)) {
                collegeDiv.style.display = 'block';
                departmentDiv.style.display = 'block';
                yearLevelDiv.style.display = 'block';
                collegeSelect.required = true;
                departmentSelect.required = true;
                yearLevelSelect.required = true;
                positionHelp.textContent = 'Department position selected - all fields required';
            }
            else if (nationalPositions.includes(selectedPosition)) {
                positionHelp.textContent = 'National position selected - no additional fields required';
            }
            else {
                positionHelp.textContent = 'Unknown position type - please select valid position';
            }
        } else {
            positionHelp.textContent = 'Select a position to see required fields';
        }
    });

    // User search functionality
    const userSearch = document.getElementById('userSearch');
    const searchResults = document.getElementById('searchResults');
    const selectedUserId = document.getElementById('selectedUserId');
    
    // Parse the JSON data provided by the server
    const users = JSON.parse('{{ users_json|escapejs }}');

    userSearch.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        if (searchTerm.length < 2) {
            searchResults.style.display = 'none';
            return;
        }

        const filteredUsers = users.filter(user => 
            user.student_number.toLowerCase().includes(searchTerm) ||
            user.name.toLowerCase().includes(searchTerm)
        );

        if (filteredUsers.length > 0) {
            searchResults.innerHTML = filteredUsers.map(user => `
                <div class="p-2 cursor-pointer hover-bg-light border-bottom user-result" 
                     data-id="${user.id}" 
                     style="cursor: pointer;">
                    <div class="fw-bold">${user.student_number}</div>
                    <div class="small text-muted">${user.name}</div>
                    <div class="small text-muted">${user.college} - ${user.course} (Year ${user.year_level})</div>
                </div>
            `).join('');
            searchResults.style.display = 'block';
        } else {
            searchResults.innerHTML = '<div class="p-2">No users found</div>';
            searchResults.style.display = 'block';
        }
    });

    // Handle click on search results
    searchResults.addEventListener('click', function(e) {
        const userResult = e.target.closest('.user-result');
        if (userResult) {
            const userId = userResult.getAttribute('data-id');
            const user = users.find(u => u.id == userId);
            
            if (user) {
                userSearch.value = `${user.student_number} - ${user.name}`;
                selectedUserId.value = userId;
                searchResults.style.display = 'none';
                console.log('Selected user ID:', userId); // Debug logging
            } else {
                console.error('User not found with ID:', userId);
            }
        }
    });

    // Hide results when clicking outside
    document.addEventListener('click', function(e) {
        if (!userSearch.contains(e.target) && !searchResults.contains(e.target)) {
            searchResults.style.display = 'none';
        }
    });

    // Add some basic styling
    const style = document.createElement('style');
    style.textContent = `
        .hover-bg-light:hover {
            background-color: #f8f9fa;
        }
        .user-result {
            transition: background-color 0.2s;
        }
    `;
    document.head.appendChild(style);
});
</script>
{% endblock %}

{% endblock %} 