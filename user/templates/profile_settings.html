{% extends 'base.html' %}
{% load static %}

{% block content %}
{% include 'nav.html' %}
<div class="min-vh-100" style="background-color: #D1ECFF;">
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-md-10">
                <!-- Profile Header -->
                <div class="card shadow-sm border-0 mb-4" style="background: linear-gradient(135deg, #34729C, #6CB1DA);">
                    <div class="card-body text-center py-4">
                        <div class="mb-3">
                            <div class="profile-image-container mx-auto position-relative" 
                                 style="width: 120px; height: 120px; border-radius: 50%; border: 4px solid #CBEAEC; overflow: hidden; background-color: #D1ECFF;">
                                {% if user_profile.profile_picture %}
                                    <img src="{{ user_profile.profile_picture.url }}" 
                                         alt="Profile Photo" class="w-100 h-100" style="object-fit: cover;">
                                {% elif user_profile.face_data %}
                                    <img src="data:image/jpeg;base64,{{ user_profile.face_data|safe }}" 
                                         alt="Profile Photo" class="w-100 h-100" style="object-fit: cover;">
                                {% else %}
                                    <i class="fas fa-user fa-4x" style="color: #34729C; line-height: 120px;"></i>
                                {% endif %}
                                
                                <!-- Profile Picture Upload Button -->
                                <label for="profile_picture_input" class="position-absolute bottom-0 start-50 translate-middle-x mb-0" 
                                       style="cursor: pointer; background-color: rgba(52, 114, 156, 0.9); padding: 5px 10px; border-radius: 15px;">
                                    <i class="fas fa-camera text-white"></i>
                                </label>
                            </div>
                        </div>
                        <h2 class="text-white mb-1">{{ user.get_full_name }}</h2>
                        <p class="text-white-50 mb-0">{{ user_profile.student_id }}</p>
                    </div>
                </div>

                <!-- Settings Card -->
                <div class="card shadow-lg border-0" style="background-color: #CBEAEC;">
                    <div class="card-body p-4">
                        <h4 class="mb-4" style="color: #1E5470;">
                            <i class="fas fa-cog me-2"></i>Account Settings
                        </h4>

                        {% if messages %}
                            {% for message in messages %}
                                <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                </div>
                            {% endfor %}
                        {% endif %}

                        <!-- Candidacy Status Section (if candidate) -->
                        {% if is_candidate %}
                            <div class="alert alert-info mb-4">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h5 class="mb-1"><i class="fas fa-flag me-2"></i>Current Candidacy Status</h5>
                                        <p class="mb-0">You are currently running for {{ candidate.position }}</p>
                                    </div>
                                    <form method="POST" onsubmit="return confirmWithdrawal()">
                                        {% csrf_token %}
                                        <button type="submit" name="withdraw_candidacy" class="btn btn-danger">
                                            <i class="fas fa-times-circle me-2"></i>Withdraw Candidacy
                                        </button>
                                    </form>
                                </div>
                            </div>
                        {% endif %}

                        <form method="POST" enctype="multipart/form-data">
                            {% csrf_token %}
                            <input type="hidden" name="update_profile" value="1">
                            <input type="file" id="profile_picture_input" name="profile_picture" class="d-none" accept="image/*">
                            
                            <!-- Personal Information -->
                            <div class="mb-4">
                                <div class="section-header d-flex align-items-center mb-3">
                                    <div class="icon-circle me-2" style="background-color: #34729C; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-user text-white small"></i>
                                    </div>
                                    <h5 class="mb-0" style="color: #1E5470;">Personal Information</h5>
                                </div>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">First Name</label>
                                        <input type="text" class="form-control" name="first_name" value="{{ user.first_name }}" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Last Name</label>
                                        <input type="text" class="form-control" name="last_name" value="{{ user.last_name }}" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Email</label>
                                        <input type="email" class="form-control" name="email" value="{{ user.email }}" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Student ID</label>
                                        <input type="text" class="form-control" name="student_id" value="{{ user_profile.student_id }}" required>
                                    </div>
                                </div>
                            </div>

                            <!-- Academic Information -->
                            <div class="mb-4">
                                <div class="section-header d-flex align-items-center mb-3">
                                    <div class="icon-circle me-2" style="background-color: #34729C; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-graduation-cap text-white small"></i>
                                    </div>
                                    <h5 class="mb-0" style="color: #1E5470;">Academic Information</h5>
                                </div>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">College</label>
                                        <select class="form-select" name="college" required>
                                            <option value="">Select College</option>
                                            {% for code, name in user_profile.COLLEGES %}
                                                <option value="{{ code }}" {% if user_profile.college == code %}selected{% endif %}>{{ name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Department</label>
                                        <select class="form-select" name="department" required>
                                            <option value="">Select Department</option>
                                            <option value="BSIT" {% if user_profile.department == "BSIT" %}selected{% endif %}>Bachelor of Science in Information Technology</option>
                                            <option value="BSCrim" {% if user_profile.department == "BSCrim" %}selected{% endif %}>Bachelor of Science in Criminology</option>
                                            <option value="BSED" {% if user_profile.department == "BSED" %}selected{% endif %}>Bachelor of Secondary Education</option>
                                            <option value="BEED" {% if user_profile.department == "BEED" %}selected{% endif %}>Bachelor of Elementary Education</option>
                                            <option value="BSBA" {% if user_profile.department == "BSBA" %}selected{% endif %}>Bachelor of Science in Business Administration</option>
                                            <option value="BSA" {% if user_profile.department == "BSA" %}selected{% endif %}>Bachelor of Science in Agriculture</option>
                                            <option value="BSFT" {% if user_profile.department == "BSFT" %}selected{% endif %}>Bachelor of Science in Food Technology</option>
                                            <option value="BSF" {% if user_profile.department == "BSF" %}selected{% endif %}>Bachelor of Science in Forestry</option>
                                            <option value="BSME" {% if user_profile.department == "BSME" %}selected{% endif %}>Bachelor of Science in Mechanical Engineering</option>
                                            <option value="BSEE" {% if user_profile.department == "BSEE" %}selected{% endif %}>Bachelor of Science in Electrical Engineering</option>
                                            <option value="BSCE" {% if user_profile.department == "BSCE" %}selected{% endif %}>Bachelor of Science in Civil Engineering</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Year Level</label>
                                        <select class="form-select" name="year_level" required>
                                            <option value="">Select Year Level</option>
                                            {% for code, name in user_profile.YEAR_LEVEL_CHOICES %}
                                                <option value="{{ code }}" {% if user_profile.year_level == code %}selected{% endif %}>{{ name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Additional Information -->
                            <div class="mb-4">
                                <div class="section-header d-flex align-items-center mb-3">
                                    <div class="icon-circle me-2" style="background-color: #34729C; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-info text-white small"></i>
                                    </div>
                                    <h5 class="mb-0" style="color: #1E5470;">Additional Information</h5>
                                </div>
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label">Gender</label>
                                        <select class="form-select" name="gender" required>
                                            <option value="">Select Gender</option>
                                            {% for code, name in user_profile.GENDER_CHOICES %}
                                                <option value="{{ code }}" {% if user_profile.gender == code %}selected{% endif %}>{{ name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Age</label>
                                        <input type="number" class="form-control" name="age" value="{{ user_profile.age }}" required min="16" max="99">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Contact Number</label>
                                        <input type="tel" class="form-control" name="contact_number" value="{{ user_profile.contact_number }}" required>
                                    </div>
                                </div>
                            </div>

                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-lg" style="background-color: #34729C; color: white;">
                                    <i class="fas fa-save me-2"></i>Save Changes
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('profile_picture_input').addEventListener('change', function(e) {
    if (e.target.files && e.target.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const profileImage = document.querySelector('.profile-image-container img') || 
                               document.querySelector('.profile-image-container i');
            
            if (profileImage.tagName === 'I') {
                // Replace icon with image
                const newImg = document.createElement('img');
                newImg.src = e.target.result;
                newImg.alt = 'Profile Photo';
                newImg.className = 'w-100 h-100';
                newImg.style.objectFit = 'cover';
                profileImage.parentNode.replaceChild(newImg, profileImage);
            } else {
                // Update existing image
                profileImage.src = e.target.result;
            }
        }
        reader.readAsDataURL(e.target.files[0]);
    }
});

function confirmWithdrawal() {
    return confirm('Are you sure you want to withdraw your candidacy? This action cannot be undone.');
}
</script>

<style>
.form-control, .form-select {
    background-color: white;
    border: 1px solid #6CB1DA;
    padding: 0.75rem;
}

.form-control:focus, .form-select:focus {
    border-color: #34729C;
    box-shadow: 0 0 0 0.25rem rgba(52, 114, 156, 0.25);
}

.form-label {
    color: #1E5470;
    font-weight: 500;
    margin-bottom: 0.5rem;
}

.section-header {
    border-bottom: 2px solid #6EC1D1;
    padding-bottom: 0.5rem;
    margin-bottom: 1.5rem;
}

.btn:hover {
    opacity: 0.9;
}

.profile-image-container label {
    opacity: 0;
    transition: opacity 0.3s ease;
}

.profile-image-container:hover label {
    opacity: 1;
}
</style>
{% endblock %} 