{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="min-vh-100" style="background: linear-gradient(135deg, #34729C, #6CB1DA);">
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="card border-0 shadow-lg" style="background-color: #CBEAEC;">
                    <div class="card-header text-center border-0 pt-4 pb-0" style="background: linear-gradient(135deg, #34729C, #6CB1DA);">
                        <h2 class="text-white mb-3">Student Registration</h2>
                        <p class="text-white-50 mb-4">Create your account to participate in the university elections</p>
                    </div>
                    
                    <div class="card-body p-4 p-md-5">
                        {% if messages %}
                            {% for message in messages %}
                                <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                </div>
                            {% endfor %}
                        {% endif %}

                        <form method="POST" enctype="multipart/form-data" class="needs-validation" novalidate>
                            {% csrf_token %}
                            
                            <!-- Face Registration Section -->
                            <div class="mb-5">
                                <h4 class="mb-4" style="color: #34729C;">
                                    <i class="fas fa-id-card me-2"></i>Face Registration
                                </h4>
                                <div class="row justify-content-center">
                                    <div class="col-md-8">
                                        <div class="card border-0 shadow-sm mb-3" style="background-color: #D1ECFF;">
                                            <div class="ratio ratio-4x3">
                                                <video id="video" class="rounded-3" style="transform: scaleX(-1);"></video>
                                            </div>
                                        </div>
                                        <div class="d-flex gap-2 justify-content-center">
                                            <button type="button" id="startCamera" class="btn" style="background-color: #34729C; color: white;">
                                                <i class="fas fa-camera-rotate me-2"></i>Start Camera
                                            </button>
                                            <button type="button" id="capture" class="btn" style="background-color: #6CB1DA; color: white;" disabled>
                                                <i class="fas fa-circle-camera me-2"></i>Capture Face
                                            </button>
                                        </div>
                                        <input type="hidden" name="face_data" id="face_data" required>
                                        <canvas id="canvas" class="d-none"></canvas>
                                    </div>
                                </div>
                            </div>

                            <!-- Account Information -->
                            <div class="mb-5">
                                <h4 class="mb-4" style="color: #34729C;">
                                    <i class="fas fa-user-gear me-2"></i>Account Information
                                </h4>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Username*</label>
                                        <div class="input-group">
                                            <span class="input-group-text" style="background-color: #34729C;">
                                                <i class="fas fa-user-tag text-white"></i>
                                            </span>
                                            <input type="text" class="form-control" name="username" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Email*</label>
                                        <div class="input-group">
                                            <span class="input-group-text" style="background-color: #34729C;">
                                                <i class="fas fa-at text-white"></i>
                                            </span>
                                            <input type="email" class="form-control" name="email" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Password*</label>
                                        <div class="input-group">
                                            <span class="input-group-text" style="background-color: #34729C;">
                                                <i class="fas fa-key text-white"></i>
                                            </span>
                                            <input type="password" class="form-control" name="password" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Confirm Password*</label>
                                        <div class="input-group">
                                            <span class="input-group-text" style="background-color: #34729C;">
                                                <i class="fas fa-key text-white"></i>
                                            </span>
                                            <input type="password" class="form-control" name="confirm_password" required>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Personal Information -->
                            <div class="mb-5">
                                <h4 class="mb-4" style="color: #34729C;">
                                    <i class="fas fa-address-badge me-2"></i>Personal Information
                                </h4>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">First Name*</label>
                                        <input type="text" class="form-control" name="first_name" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Last Name*</label>
                                        <input type="text" class="form-control" name="last_name" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Student ID*</label>
                                        <input type="text" class="form-control" name="student_id" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Contact Number*</label>
                                        <input type="tel" class="form-control" name="contact_number" required>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Age*</label>
                                        <input type="number" class="form-control" name="age" min="16" max="99" required>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Gender*</label>
                                        <select class="form-select" name="gender" required>
                                            <option value="">Select Gender</option>
                                            <option value="M">Male</option>
                                            <option value="F">Female</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Year Level*</label>
                                        <select class="form-select" name="year_level" required>
                                            <option value="">Select Year Level</option>
                                            <option value="1">First Year</option>
                                            <option value="2">Second Year</option>
                                            <option value="3">Third Year</option>
                                            <option value="4">Fourth Year</option>
                                            <option value="5">Fifth Year</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">College*</label>
                                        <select class="form-select" name="college" id="college" required onchange="updateDepartments()">
                                            <option value="">Select College</option>
                                            <option value="CAS">College of Arts and Sciences</option>
                                            <option value="CAF">College of Agriculture and Forestry</option>
                                            <option value="CCJE">College of Criminal Justice Education</option>
                                            <option value="CBA">College of Business Administration</option>
                                            <option value="CTED">College of Teacher Education</option>
                                            <option value="CIT">College of Industrial Technology</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Program*</label>
                                        <select class="form-select" name="department" id="department" required>
                                            <option value="">Select Program</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Terms and Conditions -->
                            <div class="mb-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" required id="terms">
                                    <label class="form-check-label" for="terms">
                                        I agree to the terms and conditions
                                    </label>
                                </div>
                            </div>

                            <!-- Submit Button -->
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-lg" style="background-color: #34729C; color: white;">
                                    <i class="fas fa-user-plus me-2"></i>Register Account
                                </button>
                                <a href="{% url 'login' %}" class="btn btn-lg" style="background-color: #6CB1DA; color: white;">
                                    <i class="fas fa-right-to-bracket me-2"></i>Back to Login
                                </a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.form-control, .form-select {
    background-color: #D1ECFF;
    border: 1px solid #6CB1DA;
    padding: 0.75rem;
}

.form-control:focus, .form-select:focus {
    background-color: #D1ECFF;
    border-color: #34729C;
    box-shadow: 0 0 0 0.25rem rgba(52, 114, 156, 0.25);
}

.form-label {
    color: #1E5470;
    font-weight: 500;
    margin-bottom: 0.5rem;
}

.btn {
    padding: 0.75rem 1.5rem;
    font-weight: 500;
    transition: all 0.3s ease;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.input-group-text {
    border: none;
}

.form-check-input:checked {
    background-color: #34729C;
    border-color: #34729C;
}

.card {
    border-radius: 15px;
    overflow: hidden;
}

.card-header {
    border-bottom-left-radius: 0;
    border-bottom-right-radius: 0;
}

@media (max-width: 768px) {
    .card-body {
        padding: 1.5rem;
    }
}
</style>

<script>
let video = document.getElementById('video');
let canvas = document.getElementById('canvas');
let context = canvas.getContext('2d');
let startButton = document.getElementById('startCamera');
let captureButton = document.getElementById('capture');
let stream = null;

// Set canvas size
canvas.width = 640;
canvas.height = 480;

// Start camera
startButton.addEventListener('click', async function() {
    try {
        stream = await navigator.mediaDevices.getUserMedia({ 
            video: {
                width: { ideal: 640 },
                height: { ideal: 480 },
                facingMode: "user"
            }
        });
        video.srcObject = stream;
        video.play();
        startButton.innerHTML = '<i class="fas fa-camera-slash me-2"></i>Stop Camera';
        captureButton.disabled = false;
    } catch (err) {
        console.error("Error accessing camera:", err);
        alert("Error accessing camera. Please make sure you have granted camera permissions.");
    }
});

// Capture photo
captureButton.addEventListener('click', function() {
    if (stream) {
        // Save the current context state
        context.save();
        
        // Mirror the context
        context.scale(-1, 1);
        context.translate(-canvas.width, 0);
        
        // Capture the current frame to the hidden canvas
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        // Restore the context to its original state
        context.restore();
        
        let imageData = canvas.toDataURL('image/jpeg');
        document.getElementById('face_data').value = imageData;
        
        // Visual feedback for capture
        captureButton.innerHTML = '<i class="fas fa-check me-2"></i>Photo Captured';
        captureButton.style.backgroundColor = '#28a745';
        captureButton.disabled = true;
        
        // Stop the camera
        stream.getTracks().forEach(track => track.stop());
        video.srcObject = null;
        startButton.innerHTML = '<i class="fas fa-camera-rotate me-2"></i>Start Camera';
        startButton.disabled = false;
    }
});

// Form validation
(function () {
    'use strict'
    const forms = document.querySelectorAll('.needs-validation')
    Array.from(forms).forEach(form => {
        form.addEventListener('submit', event => {
            if (!form.checkValidity()) {
                event.preventDefault()
                event.stopPropagation()
            }
            form.classList.add('was-validated')
        }, false)
    })
})()

function updateDepartments() {
    const college = document.getElementById('college').value;
    const departmentSelect = document.getElementById('department');
    
    // Clear existing options
    departmentSelect.innerHTML = '<option value="">Select Program</option>';
    
    // Define programs for each college
    const programs = {
        'CAS': [
            'Bachelor of Science in Information Technology',
            'Bachelor of Science in Computer Science'
        ],
        'CTED': [
            'Bachelor of Elementary Education',
            'BSED Major in English',
            'BSED Major in Math',
            'BSED Major in Science'
        ],
        'CBA': [
            'Bachelor of Science in Hospitality Management',
            'Bachelor of Science in Business Administration',
            'Bachelor of Science in Office Administration'
        ],
        'CIT': [
            'Bachelor of Science in Automotive Technology',
            'Bachelor of Science in Electrical Technology',
            'Bachelor of Science in Computer Technology'
        ],
        'CAF': [
            'Bachelor of Science in Agriculture Major in Agronomy',
            'Bachelor of Science in Agriculture Major in Animal Science',
            'Bachelor of Science in Forestry'
        ],
        'CCJE': [
            'Bachelor of Science in Criminology'
        ]
    };
    
    // Add options based on selected college
    if (college && programs[college]) {
        programs[college].forEach(program => {
            const option = document.createElement('option');
            option.value = program;
            option.textContent = program;
            departmentSelect.appendChild(option);
        });
    }
}

// Initialize departments on page load if college is pre-selected
document.addEventListener('DOMContentLoaded', function() {
    updateDepartments();
});
</script>
{% endblock %} 