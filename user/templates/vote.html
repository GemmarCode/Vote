{% extends 'base.html' %}
{% load static %}

{% block content %}
<!-- Face Verification Modal -->
<div class="modal fade" id="faceVerificationModal" data-bs-backdrop="static" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background-color: #CBEAEC;">
            <div class="modal-header" style="background: linear-gradient(135deg, #34729C, #6CB1DA);">
                <h5 class="modal-title text-white">
                    <i class="fas fa-camera me-2"></i>3D Face Verification Required
                </h5>
                <a href="{% url 'home' %}" class="btn-close btn-close-white" id="closeModalBtn" aria-label="Close" onclick="stopCamera()"></a>
            </div>
            <div class="modal-body text-center">
                <div class="mb-3">
                    <div id="camera-container" class="rounded overflow-hidden mx-auto" 
                         style="max-width: 400px; background-color: #D1ECFF;">
                        <video id="video" class="w-100" playsinline autoplay style="transform: scaleX(-1);"></video>
                        <canvas id="canvas" class="d-none"></canvas>
                        <canvas id="faceCanvas" class="d-none"></canvas>
                    </div>
                </div>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>Please position your face in the camera and follow the 3D scanning instructions
                </div>
                <div id="scanning-instructions" class="mb-3">
                    <p class="mb-1">1. Look straight at the camera</p>
                    <p class="mb-1">2. Slowly turn your head left and right</p>
                    <p class="mb-1">3. Look up and down</p>
                </div>
                <div id="verification-status" class="alert d-none"></div>
                <div class="progress mb-3 d-none" id="scanning-progress">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%"></div>
                </div>
                <div class="d-flex gap-2">
                    <a href="{% url 'home' %}" id="backButton" class="btn btn-lg flex-grow-1" style="background-color: #6CB1DA; color: white;" onclick="stopCamera()">
                        <i class="fas fa-arrow-left me-2"></i>Back
                    </a>
                    <button id="verifyButton" class="btn btn-lg flex-grow-1" style="background-color: #34729C; color: white;">
                        <i class="fas fa-check-circle me-2"></i>Start 3D Scan
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main Voting Content (initially hidden) -->
<div id="votingContent" class="d-none">
    <div class="bg-gradient py-4" style="background: linear-gradient(135deg, #34729C, #6CB1DA);">
        <div class="container">
            <h1 class="text-center text-white mb-0 fw-bold">Cast Your Vote</h1>
        </div>
    </div>

    <div class="container-fluid py-5" style="background-color: #D1ECFF;">
        <!-- Universal National Positions -->
        <div class="mb-5">
            <div class="d-flex align-items-center mb-4">
                <h2 class="mb-0 fw-bold" style="color: #1E5470;">National Positions</h2>
                <div class="flex-grow-1 ms-3" style="height: 2px; background-color: #6EC1D1;"></div>
            </div>
            
            {% for position, candidates in national_candidates.items %}
            {% if position == 'President' or position == 'Vice President' or position == 'Secretary' or position == 'Treasurer' or position == 'Auditor' or position == 'Public Information Officer' or position == 'Representative' %}
            <div class="card mb-4" style="background-color: #CBEAEC;">
                <div class="card-header py-3" style="background-color: #34729C;">
                    <h3 class="card-title mb-0 text-white">{{ position }}</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for candidate in candidates %}
                        <div class="col-md-4 mb-3">
                            <div class="card h-100 border-0 shadow-sm">
                                <div class="card-body text-center">
                                    <div class="mb-3">
                                        {% if candidate.photo %}
                                            <img src="{{ candidate.photo.url }}" 
                                                 class="rounded-circle" 
                                                 style="width: 120px; height: 120px; object-fit: cover;">
                                        {% else %}
                                            <div class="rounded-circle mx-auto d-flex align-items-center justify-content-center"
                                                 style="width: 120px; height: 120px; background-color: #D1ECFF;">
                                                <i class="fas fa-user fa-3x" style="color: #34729C;"></i>
                                            </div>
                                        {% endif %}
                                    </div>
                                    <h5 class="mb-1">{{ candidate.user.get_full_name }}</h5>
                                    <p class="text-muted mb-2">{{ candidate.college }}</p>
                                    <button class="btn w-100 vote-btn" 
                                            data-candidate-id="{{ candidate.id }}"
                                            style="background-color: #34729C; color: white;">
                                        <i class="fas fa-vote-yea me-2"></i>Vote
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
            {% endfor %}
        </div>

        <!-- College-Specific National Positions -->
        <div class="mb-5">
            <div class="d-flex align-items-center mb-4">
                <h2 class="mb-0 fw-bold" style="color: #1E5470;">College Positions</h2>
                <div class="flex-grow-1 ms-3" style="height: 2px; background-color: #6EC1D1;"></div>
            </div>
            
            {% for position, candidates in national_candidates.items %}
            {% if position == 'Governor' or position == 'Vice Governor' or position == 'Secretary (College)' or position == 'Treasurer (College)' or position == 'Auditor (College)' or position == 'Public Information Officer (College)' %}
            <div class="card mb-4" style="background-color: #CBEAEC;">
                <div class="card-header py-3" style="background-color: #34729C;">
                    <h3 class="card-title mb-0 text-white">{{ position }}</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for candidate in candidates %}
                        {% if candidate.college == user.userprofile.college %}
                        <div class="col-md-4 mb-3">
                            <div class="card h-100 border-0 shadow-sm">
                                <div class="card-body text-center">
                                    <div class="mb-3">
                                        {% if candidate.photo %}
                                            <img src="{{ candidate.photo.url }}" 
                                                 class="rounded-circle" 
                                                 style="width: 120px; height: 120px; object-fit: cover;">
                                        {% else %}
                                            <div class="rounded-circle mx-auto d-flex align-items-center justify-content-center"
                                                 style="width: 120px; height: 120px; background-color: #D1ECFF;">
                                                <i class="fas fa-user fa-3x" style="color: #34729C;"></i>
                                            </div>
                                        {% endif %}
                                    </div>
                                    <h5 class="mb-1">{{ candidate.user.get_full_name }}</h5>
                                    <p class="text-muted mb-2">{{ candidate.college }}</p>
                                    <button class="btn w-100 vote-btn" 
                                            data-candidate-id="{{ candidate.id }}"
                                            style="background-color: #34729C; color: white;">
                                        <i class="fas fa-vote-yea me-2"></i>Vote
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
            {% endfor %}
        </div>

        <!-- Department and Year Level Specific Positions -->
        <div>
            <div class="d-flex align-items-center mb-4">
                <h2 class="mb-0 fw-bold" style="color: #1E5470;">Department Positions</h2>
                <div class="flex-grow-1 ms-3" style="height: 2px; background-color: #6EC1D1;"></div>
            </div>
            
            {% for position, candidates in local_candidates.items %}
            <div class="card mb-4" style="background-color: #CBEAEC;">
                <div class="card-header py-3" style="background-color: #34729C;">
                    <h3 class="card-title mb-0 text-white">{{ position }}</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for candidate in candidates %}
                        {% if candidate.department == user.userprofile.department and candidate.year_level == user.userprofile.year_level %}
                        <div class="col-md-4 mb-3">
                            <div class="card h-100 border-0 shadow-sm">
                                <div class="card-body text-center">
                                    <div class="mb-3">
                                        {% if candidate.photo %}
                                            <img src="{{ candidate.photo.url }}" 
                                                 class="rounded-circle" 
                                                 style="width: 120px; height: 120px; object-fit: cover;">
                                        {% else %}
                                            <div class="rounded-circle mx-auto d-flex align-items-center justify-content-center"
                                                 style="width: 120px; height: 120px; background-color: #D1ECFF;">
                                                <i class="fas fa-user fa-3x" style="color: #34729C;"></i>
                                            </div>
                                        {% endif %}
                                    </div>
                                    <h5 class="mb-1">{{ candidate.user.get_full_name }}</h5>
                                    <p class="text-muted mb-2">{{ candidate.college }}</p>
                                    <p class="small mb-3">{{ candidate.department }} - Year {{ candidate.year_level }}</p>
                                    <button class="btn w-100 vote-btn" 
                                            data-candidate-id="{{ candidate.id }}"
                                            style="background-color: #34729C; color: white;">
                                        <i class="fas fa-vote-yea me-2"></i>Vote
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh"></script>
<script>
let video = null;
let canvas = null;
let faceCanvas = null;
let stream = null;
let isVerified = false;
let faceMesh = null;
let scanningProgress = 0;
let scanningInterval = null;

// Define stopCamera as a global function
function stopCamera() {
    console.log('Stopping camera');
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
    }
    if (scanningInterval) {
        clearInterval(scanningInterval);
    }
}

// Show face verification modal on page load
document.addEventListener('DOMContentLoaded', function() {
    const modal = new bootstrap.Modal(document.getElementById('faceVerificationModal'));
    modal.show();
    initializeCamera();
    initializeFaceMesh();
});

// Initialize MediaPipe Face Mesh
async function initializeFaceMesh() {
    faceMesh = new FaceMesh({
        locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`;
        }
    });

    faceMesh.setOptions({
        maxNumFaces: 1,
        refineLandmarks: true,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5
    });

    faceMesh.onResults(onFaceMeshResults);
}

// Handle face mesh results
function onFaceMeshResults(results) {
    if (results.multiFaceLandmarks) {
        const landmarks = results.multiFaceLandmarks[0];
        if (landmarks) {
            // Draw face mesh on canvas
            const ctx = faceCanvas.getContext('2d');
            ctx.clearRect(0, 0, faceCanvas.width, faceCanvas.height);
            
            // Draw face landmarks
            for (const landmark of landmarks) {
                const x = landmark.x * faceCanvas.width;
                const y = landmark.y * faceCanvas.height;
                ctx.fillStyle = '#34729C';
                ctx.beginPath();
                ctx.arc(x, y, 2, 0, 2 * Math.PI);
                ctx.fill();
            }
        }
    }
}

// Initialize camera
async function initializeCamera() {
    try {
        video = document.getElementById('video');
        canvas = document.getElementById('canvas');
        faceCanvas = document.getElementById('faceCanvas');
        
        stream = await navigator.mediaDevices.getUserMedia({ 
            video: {
                width: { ideal: 640 },
                height: { ideal: 480 }
            }
        });
        
        video.srcObject = stream;
        
        // Set canvas dimensions
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        faceCanvas.width = video.videoWidth;
        faceCanvas.height = video.videoHeight;
        
        // Start face mesh processing
        faceMesh.send({ image: video });
    } catch (err) {
        console.error('Error accessing camera:', err);
        showVerificationStatus('Error accessing camera. Please ensure camera permissions are granted.', 'danger');
    }
}

// Handle verification button click
document.getElementById('verifyButton').addEventListener('click', async function() {
    const button = this;
    const progressBar = document.getElementById('scanning-progress');
    
    if (!isVerified) {
        // Start 3D scanning process
        button.disabled = true;
        progressBar.classList.remove('d-none');
        scanningProgress = 0;
        
        scanningInterval = setInterval(() => {
            scanningProgress += 5;
            progressBar.querySelector('.progress-bar').style.width = `${scanningProgress}%`;
            
            if (scanningProgress >= 100) {
                clearInterval(scanningInterval);
                performVerification();
            }
        }, 100);
    }
});

async function performVerification() {
    try {
        const verificationStatus = document.getElementById('verification-status');
        verificationStatus.classList.remove('d-none');
        verificationStatus.className = 'alert alert-info';
        verificationStatus.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Verifying 3D face data...';

        // Capture current frame
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d');
        
        // Draw the video frame to match the mirrored display
        ctx.scale(-1, 1);
        ctx.drawImage(video, -canvas.width, 0);
        ctx.scale(-1, 1); // Reset scale
        
        const imageData = canvas.toDataURL('image/jpeg', 1.0);

        // Send to server for verification
        const response = await fetch('/api/verify-face/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ 
                face_data: imageData,
                type: 'verify'
            })
        });

        const result = await response.json();

        if (result.verified === 'true') {
            verificationStatus.className = 'alert alert-success';
            verificationStatus.innerHTML = '<i class="fas fa-check-circle me-2"></i>3D face verification successful!';
            isVerified = true;
            
            // Stop camera and hide modal after 1 second
            setTimeout(() => {
                stopCamera();
                bootstrap.Modal.getInstance(document.getElementById('faceVerificationModal')).hide();
                document.getElementById('votingContent').classList.remove('d-none');
            }, 1000);
        } else {
            let errorMessage = result.message || 'Verification failed. Please try again.';
            showVerificationStatus(errorMessage, 'danger');
            document.getElementById('verifyButton').disabled = false;
        }
    } catch (err) {
        console.error('Error during verification:', err);
        showVerificationStatus('Error during verification. Please try again.', 'danger');
        document.getElementById('verifyButton').disabled = false;
    }
}

function showVerificationStatus(message, type) {
    const status = document.getElementById('verification-status');
    status.classList.remove('d-none');
    status.className = `alert alert-${type}`;
    status.innerHTML = message;
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %} 